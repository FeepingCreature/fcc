module std.stream;

class iter {
  int delegate(byte[]) dg;
  byte x 512 buffer;
  byte[] value;
  bool advance() {
    int pos = dg buffer[];
    if pos == -1 {
      return false;
    }
    value = buffer[0..pos];
    return true;
  }
}

iter readDg(int delegate(byte[]) dg) {
  auto res = new iter;
  res.dg = dg;
  return res;
}

template dgIter(T) <<EOF
  class DelegateIterator {
    T t;
    alias dg = t;
    type-of dg() step() { return dg(); }
    bool ivalid() { return true; }
  }
  auto dgIter(T t) {
    auto res = new DelegateIterator;
    res.t = t;
    return res;
  }
EOF
